#!/bin/zsh
# shellcheck shell=zsh

DEBUG=true
trap 'echo "\n[updater] Stopped."; exit 0' INT

# Usage: updater.sh <file-to-sync> [name-of-command]
if [[ -z $1 ]]; then
      echo "Usage: $0 <file-to-sync> [name-of-command]"
      exit 1
fi

srcfolder="$1"
filename="$1/main.sh"
basename="${srcfolder%.*}"
cmd="${2:-$basename}"

echo $srcfolder;
echo $filename;
echo $basename;
echo $cmd;
exit 0;

mkdir -p ~/src ~/bin

while true; do

      if [[ ! -f "$this" ]]; then
            echo "File $this does not exist. Exiting..."
            exit 1
      fi

      [[ "$DEBUG" = true ]] && echo "DEBUG: this=$this" && echo "DEBUG: cmd=$cmd"

      mkdir -p "$HOME/src/${basename}/src"
      mkdir -p "$HOME/src/${basename}/bin"
      dst_src="$HOME/src/${basename}/src/$cmd"
      dst_bin="$HOME/src/${basename}/bin/$cmd"
      dst_final="$HOME/bin/$cmd"

      if cmp -s "$this" "$dst_final"; then
            [[ "$DEBUG" = true ]] && echo "No changes detected. Skipping..."
            continue
      fi

      echo "[$(date '+%H:%M:%S')] Changes detected. Syncing..."
      cp "$this" "$dst_src"
      chmod +x "$dst_src"

      shc -o "$dst_bin" -f "$dst_src"
      ditto "$dst_bin" "$dst_final"
      echo "[$(date '+%H:%M:%S')] Updated $dst_final"

      sleep 5
done
